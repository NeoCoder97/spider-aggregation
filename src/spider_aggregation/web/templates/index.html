{% extends "base.html" %}

{% block title %}æ–‡ç« åˆ—è¡¨ - MindWeaver{% endblock %}

{% block content %}
<div class="page-header">
    <h2>æ–‡ç« åˆ—è¡¨</h2>
    <div class="stats">
        <span>æ€»è®¡: {{ total }}</span>
    </div>
</div>

<div class="filters">
    <form method="get" class="filter-form">
        <select name="feed_id" class="filter-select">
            <option value="">å…¨éƒ¨è®¢é˜…æº</option>
            {% for feed in feeds %}
            <option value="{{ feed.id }}" {% if feed_id == feed.id %}selected{% endif %}>
                {{ feed.name }}
            </option>
            {% endfor %}
        </select>

        <input type="text" name="q" placeholder="æœç´¢..." value="{{ search_query }}" class="search-input">

        <button type="submit" class="btn btn-primary">ç­›é€‰</button>
        {% if feed_id or search_query %}
        <a href="{{ url_for('index') }}" class="btn btn-secondary">æ¸…é™¤</a>
        {% endif %}
    </form>
</div>

<!-- Batch Operations Toolbar -->
<div class="batch-toolbar">
    <label class="batch-toolbar-label">
        <input type="checkbox" onchange="toggleSelectAll(this)">
        å…¨é€‰
    </label>
    <div class="batch-actions">
        <button type="button" class="btn btn-small btn-secondary" onclick="batchFetchContent()" title="ä¸ºé€‰ä¸­çš„æ–‡ç« æå–å®Œæ•´å†…å®¹">
            ğŸ“„ æå–å†…å®¹
        </button>
        <button type="button" class="btn btn-small btn-secondary" onclick="batchExtractKeywords()" title="ä¸ºé€‰ä¸­çš„æ–‡ç« æå–å…³é”®è¯">
            ğŸ·ï¸ æå–å…³é”®è¯
        </button>
        <button type="button" class="btn btn-small btn-secondary" onclick="batchSummarize()" title="ä¸ºé€‰ä¸­çš„æ–‡ç« ç”Ÿæˆæ‘˜è¦">
            ğŸ“ ç”Ÿæˆæ‘˜è¦
        </button>
        <button type="button" class="btn btn-small btn-danger" onclick="batchDeleteEntries()" title="åˆ é™¤é€‰ä¸­çš„æ–‡ç« ">
            ğŸ—‘ï¸ åˆ é™¤
        </button>
    </div>
</div>

<div class="entries-list">
    {% for entry in entries %}
    <article class="entry-card">
        <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
            <input type="checkbox" class="entry-checkbox" value="{{ entry.id }}" style="margin-top: 0.5rem;">
            <div style="flex: 1;">
                <h3 class="entry-title">
                    <a href="{{ url_for('entry_detail', entry_id=entry.id) }}">{{ entry.title }}</a>
                </h3>
                <div class="entry-meta">
                    {% if entry.author %}
                    <span class="entry-author">{{ entry.author }}</span>
                    {% endif %}
                    {% if entry.published_at %}
                    <span class="entry-date">{{ entry.published_at|format_datetime }}</span>
                    {% endif %}
                    {% if entry.language %}
                    <span class="badge badge-secondary">{{ entry.language.upper() }}</span>
                    {% endif %}
                </div>
                {% if entry.summary %}
                <p class="entry-summary">{{ entry.summary[:300] }}{% if entry.summary|length > 300 %}...{% endif %}</p>
                {% elif entry.content %}
                <p class="entry-summary">{{ entry.content[:300] }}{% if entry.content|length > 300 %}...{% endif %}</p>
                {% endif %}
                {% if entry.tags_list %}
                <div class="entry-tags">
                    {% for tag in entry.tags_list[:5] %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="entry-actions">
                    <a href="{{ entry.link }}" target="_blank" rel="noopener" class="btn btn-small">æŸ¥çœ‹åŸæ–‡</a>
                    <a href="{{ url_for('entry_detail', entry_id=entry.id) }}" class="btn btn-small btn-secondary">è¯¦æƒ…</a>
                </div>
            </div>
        </div>
    </article>
    {% else %}
    <div class="empty-state">
        <p>æš‚æ— æ–‡ç« </p>
    </div>
    {% endfor %}
</div>

{% if total > page_size %}
<div class="pagination">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}&feed_id={{ feed_id or '' }}&q={{ search_query }}" class="btn">ä¸Šä¸€é¡µ</a>
    {% endif %}

    <span class="pagination-info">
        ç¬¬ {{ page }} / {{ total // page_size + (1 if total % page_size else 0) }} é¡µ
        (å…± {{ total }} æ¡)
    </span>

    {% set total_pages = total // page_size + (1 if total % page_size else 0) %}
    {% set max_pages = 7 %}
    {% set start_page = [1, page - 3]|max %}
    {% set end_page = [total_pages, page + 3]|min %}

    {% if start_page > 1 %}
    <a href="?page=1&feed_id={{ feed_id or '' }}&q={{ search_query }}" class="btn btn-small">1</a>
    {% if start_page > 2 %}
    <span class="pagination-ellipsis">...</span>
    {% endif %}
    {% endif %}

    {% for p in range(start_page, end_page + 1) %}
    {% if p == page %}
    <span class="btn btn-small btn-primary">{{ p }}</span>
    {% else %}
    <a href="?page={{ p }}&feed_id={{ feed_id or '' }}&q={{ search_query }}" class="btn btn-small">{{ p }}</a>
    {% endif %}
    {% endfor %}

    {% if end_page < total_pages %}
    {% if end_page < total_pages - 1 %}
    <span class="pagination-ellipsis">...</span>
    {% endif %}
    <a href="?page={{ total_pages }}&feed_id={{ feed_id or '' }}&q={{ search_query }}" class="btn btn-small">{{ total_pages }}</a>
    {% endif %}

    {% if page * page_size < total %}
    <a href="?page={{ page + 1 }}&feed_id={{ feed_id or '' }}&q={{ search_query }}" class="btn">ä¸‹ä¸€é¡µ</a>
    {% endif %}

    <form method="get" class="pagination-jump" style="display: inline; margin-left: 1rem;">
        <input type="hidden" name="feed_id" value="{{ feed_id or '' }}">
        <input type="hidden" name="q" value="{{ search_query }}">
        <input type="number" name="page" min="1" max="{{ total // page_size + (1 if total % page_size else 0) }}" placeholder="é¡µç " class="form-control" style="width: 60px; display: inline;">
        <button type="submit" class="btn btn-small">è·³è½¬</button>
    </form>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/forms.js') }}"></script>
{% endblock %}
